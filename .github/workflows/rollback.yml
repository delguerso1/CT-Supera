name: Rollback para Backup Anterior

on:
  workflow_dispatch:
    inputs:
      backup_name:
        description: 'Nome do backup (deixe vazio para usar o mais recente)'
        required: false
        type: string

jobs:
  rollback:
    name: Executar Rollback
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://ctsupera.com.br
    
    steps:
      - name: Configurar SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts

      - name: Listar backups dispon√≠veis
        run: |
          ssh ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
            echo "üì¶ Backups dispon√≠veis:"
            cd /root/backups
            ls -lht ct-supera-backup-*.tar.gz | head -10
          EOF

      - name: Executar rollback
        run: |
          ssh ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
            set -e
            cd /root/backups
            
            backup_name="${{ github.event.inputs.backup_name }}"
            
            if [ -z "$backup_name" ]; then
              # Usar backup mais recente
              backup_file=$(ls -t ct-supera-backup-*.tar.gz | head -1)
              echo "üì¶ Usando backup mais recente: $backup_file"
            else
              backup_file="$backup_name"
              echo "üì¶ Usando backup especificado: $backup_file"
            fi
            
            if [ ! -f "$backup_file" ]; then
              echo "‚ùå Backup n√£o encontrado: $backup_file"
              exit 1
            fi
            
            echo "‚ö†Ô∏è Criando backup de seguran√ßa do estado atual..."
            cd /root
            tar -czf backups/ct-supera-pre-rollback-$(date +%Y%m%d-%H%M%S).tar.gz ct-supera/
            
            echo "üîÑ Restaurando backup..."
            rm -rf ct-supera.rollback
            mv ct-supera ct-supera.rollback
            tar -xzf backups/$backup_file
            
            echo "üîÑ Reiniciando servi√ßo..."
            systemctl restart ctsupera
            sleep 3
            
            echo "‚úÖ Rollback conclu√≠do!"
            systemctl status ctsupera --no-pager -l | head -15
          EOF

      - name: Verificar aplica√ß√£o
        run: |
          echo "üåê Verificando se a aplica√ß√£o est√° respondendo..."
          curl -I https://ctsupera.com.br || echo "‚ö†Ô∏è Aplica√ß√£o pode estar offline"

      - name: Notificar resultado
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Rollback realizado com sucesso!"
          else
            echo "‚ùå Rollback falhou!"
          fi

